# ruby,rails
alias b="bundle"
alias be="bundle exec"
alias bespec="bundle exec rspec"
alias betest="bundle exec rake test"

alias ru="ruby"
alias t="thor"
alias d="docker"
alias dcom="docker-compose"

# git
alias g='git'
alias gs='git status'
alias gb='git branch'
alias gd='git diff'
alias gdt='git difftool'
alias gf='git fetch'
alias gg='git grep'

# ls
case "${OSTYPE}" in
darwin*)
  alias ls='ls -G'
  alias ll='ls -la'
  alias la="ll"
  ;;
linux*)
  alias ls='ls --color'
  alias ll='ls -l --color'
  alias la='ls -la --color'
  ;;
esac

#cd
alias src='cd ~/src'

alias reload_bashrc='. ~/.bashrc'

# AWS
alias a='aws'

#GCP & Kuberentes
alias k='kubectl'
alias kg='kubectl get'
alias kd='kubectl describe'
alias gc='gcloud'
alias c='gcloud'

alias h='hub'
alias v='vim'

#
# misc
alias ghost='gh-ost'

# elixir
alias e='elixir'

function review() {
  branch=$1
  if [[ -z $REVIEW_INTEGRATION_BRANCH ]]
  then
    REVIEW_INTEGRATION_BRANCH="origin/master"
  fi

  git checkout -B code-review
  git remote update
  git reset --hard ${REVIEW_INTEGRATION_BRANCH}

  git merge $branch

  echo "Reviewing branch $branch"
}

function end-review() {
  if [[ -z $REVIEW_INTEGRATION_BRANCH ]]
  then
    REVIEW_INTEGRATION_BRANCH="origin/master"
  fi
  if [[ -z $REVIEW_LOCAL_BRANCH ]]
  then
    REVIEW_LOCAL_BRANCH="master"
  fi

  git remote update
  git checkout -B code-review
  git reset --hard ${REVIEW_INTEGRATION_BRANCH}
  git checkout -B ${REVIEW_LOCAL_BRANCH}
  git reset --hard ${REVIEW_INTEGRATION_BRANCH}
}

function pdc-pid() {
  docker ps | peco | awk '{print $1}'
}

function pdc-logs() {
  target=`pdc-pid`
  docker logs ${target}
}

# Kubernetes
function pk8-pods() {
  kubectl get pod | peco | awk '{print $1}'
}

function pk8-logs() {
  target=`pk8-pods`

  if [ "$1" = "-f" ];then
    kubectl logs $1 ${target} $2
  else
    kubectl logs ${target} $1
  fi
}

function k8watch() {
  watch -n 1 kubectl get $1
}


# Google Cloud Platform
function switch-gcp-project() {
  proj=`gcloud projects list | peco | awk '{print $1}'`
  gcloud config set project ${proj}
}

# ssh
function historyssh() {
  history | grep " ssh " | awk '!colname[$3]++{print($2,$3)}' | sort | uniq
}

function latest-ssh() {
  `historyssh | awk 'END {print}'` $@
}

function p-ssh() {
  `historyssh | peco` $@
}


function get-env-dockertag() {
  if [ -z "$DOCKER_BASE" ];then
    echo "DOCKER_BASE enviroment not defined." >&2
    exit 1
  fi

  tag=${TAG:-'latest'}
  tag=${1:-$tag}
  echo ${DOCKER_BASE}:${tag}
}

function docker-run-default() {
  tag=`get-env-dockertag $@`
  docker run -it $tag /bin/sh
}

function docker-push-default() {
  tag=`get-env-dockertag $@`
  docker push -t $tag
}

function gcp-docker-push-default() {
  tag=`get-env-dockertag $@`
  echo "gcloud docker push ${tag}"
  gcloud docker -- push $tag
}
alias dp='docker-push-default'
alias dpg='gcp-docker-push-default'

function docker-build-default() {
  if [ -z "$DOCKER_BASE" ];then
    echo "DOCKER_BASE enviroment not defined."
  fi

  tag=${TAG:-'latest'}
  tag=${1:-$tag}

  echo "Docker Build ${DOCKER_BASE}:${tag}"
  docker build -t ${DOCKER_BASE}:${tag} .
}
alias db='docker-build-default'

function docker-print-tag() {
  tag=${TAG:-'latest'}
  echo "${DOCKER_BASE}:${tag}"
}
alias dpt='docker-print-tag'

function pexec() {
  `ls | peco`
}

function ggedit() {
  vim -p `git grep -l $1 | peco`
}

function peco-history() {
    local tac
    if which tac > /dev/null; then
        tac="tac"
    else
        tac="tail -r"
    fi
    BUFFER=$(\history -n 1 | \
        eval $tac | \
        peco --query "$LBUFFER")
    CURSOR=$#BUFFER
    zle clear-screen
}
zle -N peco-history
bindkey '^r' peco-history

function print_known_hosts (){
  if [ -f $HOME/.ssh/known_hosts ]; then
    cat ~/.ssh/known_hosts | tr ',' ' ' | cut -d' ' -f1
  fi
}
_cache_hosts=($( print_known_hosts ))


alias rails-ctags='ctags --langmap=RUBY:.rb --exclude="*.js"  --exclude=".git*" -R .'

